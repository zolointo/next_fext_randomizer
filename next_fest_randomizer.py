"""
next_fest_randomizer.py
--------------
Generates HTML pages with a table of Steam games, their store links,
and embedded trailers played via MPEG-DASH (dash.js).

Uses async Playwright to process multiple games concurrently (default: 10 at a time),
and splits output into files of 100 games each named rando_bin_1.html, rando_bin_2.html, etc.

Setup (one time):
    pip install playwright requests
    playwright install chromium

Usage:
    python steam_table.py                         # uses hardcoded appids list below
    python steam_table.py 405006 1091500 292030   # pass appids as CLI args
"""

import asyncio
import collections
import random
import sys
import time
from pathlib import Path

import requests
from playwright.async_api import async_playwright, TimeoutError as PlaywrightTimeout


# ---------------------------------------------------------------------------
# Configuration
# ---------------------------------------------------------------------------

CONCURRENCY    = 10   # number of games to process in parallel
CHUNK_SIZE     = 100  # games per output HTML file
OUTPUT_PREFIX  = "rando_bin"

# How long (seconds) to wait for an MPD request to appear after clicking play
MPD_WAIT_SECONDS = 15

# Cookies to bypass age gate and mature content warnings
STEAM_COOKIES = [
    {"name": "birthtime",       "value": "0",        "domain": ".steampowered.com", "path": "/"},
    {"name": "mature_content",  "value": "1",        "domain": ".steampowered.com", "path": "/"},
    {"name": "lastagecheckage", "value": "1-0-1990", "domain": ".steampowered.com", "path": "/"},
]


# ---------------------------------------------------------------------------
# Rate limiter â€” sliding window, thread-safe via asyncio lock
# ---------------------------------------------------------------------------

class RateLimiter:
    """
    Sliding-window rate limiter.

    Allows at most `max_calls` calls within any `period` second window.
    Callers await `acquire()` which blocks until a slot is available,
    then logs a message if it has to wait so you know what's happening.
    """

    def __init__(self, max_calls: int, period: float):
        self.max_calls = max_calls
        self.period    = period
        self.timestamps: collections.deque = collections.deque()
        self.lock = asyncio.Lock()

    async def acquire(self):
        async with self.lock:
            now = time.monotonic()

            # Drop timestamps that have fallen outside the window
            while self.timestamps and now - self.timestamps[0] >= self.period:
                self.timestamps.popleft()

            if len(self.timestamps) >= self.max_calls:
                # Oldest timestamp tells us when a slot opens up
                wait_until = self.timestamps[0] + self.period
                wait_for   = wait_until - now
                print(f"  [rate limiter] API limit reached â€” waiting {wait_for:.1f}s "
                      f"for next window...", file=sys.stderr)
                await asyncio.sleep(wait_for)

                # Purge again after sleeping
                now = time.monotonic()
                while self.timestamps and now - self.timestamps[0] >= self.period:
                    self.timestamps.popleft()

            self.timestamps.append(time.monotonic())


# One shared limiter: 195 requests per 300 seconds (a little headroom under the 200 limit)
api_limiter = RateLimiter(max_calls=195, period=300)




def get_steam_app_data(appid: int, retries: int = 5) -> dict | None:
    """Fetch basic app metadata (name, header image) from the Steam Store API.
    
    Retries with exponential backoff on failure to handle rate limiting.
    """
    url = f"https://store.steampowered.com/api/appdetails?appids={appid}"
    for attempt in range(1, retries + 1):
        try:
            resp = requests.get(url, timeout=15)
            resp.raise_for_status()
            entry = resp.json().get(str(appid), {})
            if entry.get("success"):
                return entry["data"]
            # success=false often means rate limited â€” retry
            wait = 2 ** attempt
            print(f"  [!] API success=false for appid {appid} "
                  f"(attempt {attempt}/{retries}, retrying in {wait}s)", file=sys.stderr)
            time.sleep(wait)
        except Exception as e:
            wait = 2 ** attempt
            print(f"  [!] API error for appid {appid}: {e} "
                  f"(attempt {attempt}/{retries}, retrying in {wait}s)", file=sys.stderr)
            time.sleep(wait)
    print(f"  [!] Giving up on appid {appid} after {retries} attempts", file=sys.stderr)
    return None


# ---------------------------------------------------------------------------
# Async Playwright: intercept the MPD URL
# ---------------------------------------------------------------------------

async def get_mpd_url_via_browser(context, appid: int) -> str | None:
    """
    Open a new page in the given browser context, navigate to the Steam store
    page for `appid`, click play, and intercept the .mpd network request.

    Returns the MPD URL string, or None if not found within the timeout.
    """
    mpd_url = None
    page = await context.new_page()

    try:
        def handle_request(request):
            nonlocal mpd_url
            if mpd_url is None and ".mpd" in request.url:
                mpd_url = request.url
                print(f"  [{appid}] Intercepted MPD: {mpd_url}")

        page.on("request", handle_request)

        store_url = f"https://store.steampowered.com/app/{appid}/"
        print(f"  [{appid}] Navigating...")
        await page.goto(store_url, wait_until="domcontentloaded", timeout=30_000)

        # Dismiss any cookie/age-gate banners
        for selector in [
            "#cookieAgreementPopup .btn_medium",
            ".agegate_text_container .btn_medium",
            "#age_gate_btn_continue",
        ]:
            try:
                btn = page.locator(selector).first
                if await btn.is_visible(timeout=2_000):
                    await btn.click()
            except Exception:
                pass

        # Click the trailer play button
        play_selectors = [
            "[data-trailer-player] .vXKdKnTS2vXaw2YxC0Yc1",
            "[data-trailer-player]",
        ]
        clicked = False
        for selector in play_selectors:
            try:
                el = page.locator(selector).first
                await el.wait_for(state="visible", timeout=8_000)
                await el.click()
                print(f"  [{appid}] Clicked play")
                clicked = True
                break
            except Exception:
                continue

        if not clicked:
            print(f"  [{appid}] [!] Could not find/click play button", file=sys.stderr)

        # Wait for the MPD request to be intercepted
        deadline = time.time() + MPD_WAIT_SECONDS
        while mpd_url is None and time.time() < deadline:
            await asyncio.sleep(0.25)

        if mpd_url is None:
            print(f"  [{appid}] [!] No MPD URL intercepted within {MPD_WAIT_SECONDS}s",
                  file=sys.stderr)

    except PlaywrightTimeout as e:
        print(f"  [{appid}] [!] Timeout: {e}", file=sys.stderr)
    except Exception as e:
        print(f"  [{appid}] [!] Error: {e}", file=sys.stderr)
    finally:
        await page.close()

    return mpd_url


# ---------------------------------------------------------------------------
# Worker: processes a single appid
# ---------------------------------------------------------------------------

async def process_appid(semaphore, context, appid: int, idx: int) -> dict:
    async with semaphore:
        print(f"\nProcessing appid {appid}...")

        await asyncio.sleep(random.uniform(0, 2))

        await api_limiter.acquire()
        api_data = await asyncio.to_thread(get_steam_app_data, appid)
        name         = api_data.get("name", f"App {appid}") if api_data else f"App {appid}"
        header_image = api_data.get("header_image", "")      if api_data else ""
        store_url    = f"https://store.steampowered.com/app/{appid}/"

        mpd_url = await get_mpd_url_via_browser(context, appid)

        return {
            "idx":          idx,
            "appid":        appid,
            "name":         name,
            "store_url":    store_url,
            "header_image": header_image,
            "mpd_url":      mpd_url,
        }


# ---------------------------------------------------------------------------
# HTML generation
# ---------------------------------------------------------------------------

HTML_TEMPLATE = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Games â€” {title}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/4.7.4/dash.all.min.js"></script>
    <style>
        * {{ box-sizing: border-box; margin: 0; padding: 0; }}
        body {{
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1b2838;
            color: #c6d4df;
            padding: 24px;
        }}
        h1 {{
            color: #66c0f4;
            text-align: center;
            margin-bottom: 28px;
            font-size: 1.8rem;
            letter-spacing: 0.04em;
        }}
        table {{
            width: auto;
            margin: 0 auto;
            border-collapse: collapse;
            background: #16202d;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 24px rgba(0,0,0,0.5);
        }}
        thead {{ background: #1e3a5f; }}
        th {{
            padding: 14px 20px;
            text-align: left;
            font-size: 0.85rem;
            color: #66c0f4;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }}
        td {{
            padding: 18px 20px;
            border-bottom: 1px solid #2a3f5f;
            vertical-align: middle;
        }}
        tr:last-child td {{ border-bottom: none; }}
        tr:hover {{ background: #1a2e47; }}
        .name-cell {{ min-width: 180px; }}
        .name-cell a {{
            color: #66c0f4;
            text-decoration: none;
            font-size: 1.05rem;
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }}
        .name-cell a:hover {{ text-decoration: underline; color: #a0d4f5; }}
        .app-id {{ font-size: 0.75rem; color: #7a8fa8; }}
        .video-wrapper video {{
            display: block;
            border-radius: 6px;
            background: #000;
            max-width: 100%;
        }}
        .no-trailer {{ color: #7a8fa8; font-style: italic; }}
        .error-msg {{ color: #e06c6c; font-size: 0.85rem; }}
    </style>
</head>
<body>
    <h1>ðŸŽ® Steam Games</h1>
    <table>
        <thead>
            <tr><th>Game</th><th>Trailer</th></tr>
        </thead>
        <tbody>
            {rows}
        </tbody>
    </table>
    <script>
    document.addEventListener('DOMContentLoaded', function () {{
        document.querySelectorAll('video[data-mpd]').forEach(function (videoEl) {{
            var mpdUrl = videoEl.getAttribute('data-mpd');
            if (!mpdUrl) return;

            var player = null;
            var ready = false;
            var pendingPlay = false;

            function initPlayer() {{
                if (player) return;
                try {{
                    player = dashjs.MediaPlayer().create();
                    player.initialize(videoEl, mpdUrl, false);
                    player.updateSettings({{
                        streaming: {{ abr: {{ autoSwitchBitrate: {{ video: true }} }} }}
                    }});
                    player.on(dashjs.MediaPlayer.events.CAN_PLAY, function () {{
                        ready = true;
                        if (pendingPlay) {{
                            pendingPlay = false;
                            videoEl.play();
                        }}
                    }});
                }} catch (err) {{
                    videoEl.parentElement.innerHTML =
                        '<span class="error-msg">Could not initialise DASH player: ' + err.message + '</span>';
                }}
            }}

            videoEl.addEventListener('mouseenter', function () {{
                if (!player) {{
                    pendingPlay = true;
                    initPlayer();
                }} else if (ready) {{
                    videoEl.play();
                }} else {{
                    pendingPlay = true;
                }}
            }});

            videoEl.addEventListener('mouseleave', function () {{
                pendingPlay = false;
                videoEl.pause();
            }});
        }});
    }});
    </script>
</body>
</html>
"""


def build_html(results: list[dict], title: str) -> str:
    rows = []
    for r in results:
        if r["mpd_url"]:
            video_cell = f"""
                <div class="video-wrapper">
                    <video
                        id="video-{r['appid']}"
                        data-mpd="{r['mpd_url']}"
                        poster="{r['header_image']}"
                        muted
                        controls
                        width="960"
                        preload="none">
                    </video>
                </div>"""
        else:
            video_cell = "<em class='no-trailer'>No trailer available</em>"

        rows.append(f"""
        <tr>
            <td class="name-cell">
                <a href="{r['store_url']}" target="_blank">{r['name']}</a>
                <div class="app-id">App ID: {r['appid']}</div>
            </td>
            <td class="trailer-cell">
                {video_cell}
            </td>
        </tr>""")

    return HTML_TEMPLATE.format(title=title, rows="".join(rows))


# ---------------------------------------------------------------------------
# Main async entry point
# ---------------------------------------------------------------------------

async def main(appids: list[int]):
    # Split into chunks
    chunks = [appids[i:i + CHUNK_SIZE] for i in range(0, len(appids), CHUNK_SIZE)]
    total_chunks = len(chunks)
    print(f"Processing {len(appids)} appids â†’ {total_chunks} file(s) of up to {CHUNK_SIZE} each\n")

    async with async_playwright() as pw:
        browser = await pw.chromium.launch(headless=True)
        context = await browser.new_context(
            viewport={"width": 1280, "height": 800},
            user_agent=(
                "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                "AppleWebKit/537.36 (KHTML, like Gecko) "
                "Chrome/122.0.0.0 Safari/537.36"
            ),
        )
        await context.add_cookies(STEAM_COOKIES)

        semaphore = asyncio.Semaphore(CONCURRENCY)

        for i, batch in enumerate(chunks, start=1):
            output_file = f"{OUTPUT_PREFIX}_{i}.html"
            print(f"\n{'='*60}")
            print(f"Batch {i}/{total_chunks} â†’ {output_file} ({len(batch)} games)")
            print(f"{'='*60}")

            # Process all games in this batch concurrently (up to CONCURRENCY at once)
            tasks = [process_appid(semaphore, context, appid, idx)
                     for idx, appid in enumerate(batch)]
            results = await asyncio.gather(*tasks)
            results = sorted(results, key=lambda r: r["idx"])

            html = build_html(results, title=output_file)
            Path(output_file).write_text(html, encoding="utf-8")

            found = sum(1 for r in results if r["mpd_url"])
            print(f"\nâœ… Written: {output_file} ({found}/{len(results)} trailers found)")

        await browser.close()

    print(f"\nðŸŽ‰ All done! {total_chunks} file(s) generated.")


# ---------------------------------------------------------------------------
# Entry point
# ---------------------------------------------------------------------------

if __name__ == "__main__":
    # Edit this list with your desired Steam App IDs
    appids = [
      4418410,4342220,4082640,4312420,4384330,4228680,4300040,3517230,3341760,4422610,4225730,4294310,3625510,3712410,3801310,3590190,3045420,4185090,2822250,4232920,4281000,2490290,4419580,4199980,4358790,4170140,4154850,4407050,4023820,4422530,3983290,3166800,2420020,4303500,4255700,3806390,3782050,3299310,4002750,4394630,4392390,4189070,4238930,4222110,4026820,4264910,4364460,4407980,2962900,4283770,3891110,4218910,4346630,4200030,3964250,4381010,4265550,4159640,3895790,4094550,4082800,3318790,4289090,4303950,3767410,4361850,4157730,3432940,4182300,4347930,4241810,2953830,4316090,2831290,4333150,4365080,4275350,4232120,4299500,3194540,3858710,4202700,4097110,4400470,4356670,4174820,3972670,4214550,4343530,4435280,4182420,4219710,3651590,2980640,4405450,4180350,4288620,4039560,4372570,4187890,4246650,4228850,4286450,4239280,3877560,4385750,4243780,4344750,4023570,4053980,2989810,4374880,4365810,4211670,4161530,4373200,4422480,4386150,4415190,4200820,4240890,4209420,4062610,4325190,4031420,4152220,4397990,4389320,3400280,4415670,4346930,3758550,3945820,4373400,4299380,4318910,4256260,4301430,4331880,4340520,3970850,4208410,4411410,4116510,4089270,4262040,3915930,4359500,4018360,4218320,3947930,4332480,4247270,4367050,4366130,4289040,4384690,4371670,4263270,4183030,4440630,4356700,4277300,3238150,4303730,4307720,4228980,4124040,3906210,4135450,4028970,4047050,4417290,3475810,4106170,3917040,4285430,4079030,4376730,4355140,4347650,4329130,4289630,4244070,2980210,4347510,4326840,4305950,4369270,3274760,4211270,3995630,4312930,2972060,3451710,4366230,4073250,4145650,4400780,4351140,4377920,4408480,4319410,2611210,4363200,3920750,3524520,4194590,4315980,4316300,4216120,4403380,4342770,3976570,2486900,3967210,4219170,4397170,4120140,3628930,4359330,4360490,4275850,4342540,4250860,4404840,3174750,3983530,4293760,3268620,4177090,4385280,4062500,4078680,3392450,4304960,2344870,4324140,4371960,3815270,3809320,3952340,2861500,3173210,2421490,4390440,4361420,4300550,3001720,4140490,4425850,4271120,4329570,4420820,4223270,4086610,3964370,4397890,3909540,3262980,4269200,4390860,4377450,4374450,4134560,4295350,2812210,4361040,4220500,4029420,4183960,4418290,2328850,4356760,4242950,4410390,4367360,4341290,4288280,3303110,3749100,3690520,4124020,4265190,4342390,4381910,4310000,4042010,4282090,4414750,4231450,3110830,3957220,4245000,3830660,3915340,4408170,4339930,4257170,4158490,4254240,4352820,4392960,4368220,3925170,4369520,4040410,3761480,4378710,3917920,3162710,4374500,4139700,3820780,4369650,4347420,4162140,4260660,4308820,4364170,2447500,4340470,3959810,4103470,4179690,4110330,4411980,4136390,2526480,4083850,4052210,4351030,3772560,3689970,4374040,4211480,4317930,3647930,4272550,4324580,4339290,4011690,3876820,4377770,4358450,4236390,4305580,4297790,4213870,4265290,3963540,4256180,4291990,3728630,4122570,4291600,4378210,4184480,4239470,3818680,4432820,4362110,4397870,4138950,4155590,4041250,4217760,4213470,2732830,4356650,4229500,4266900,4175160,4143540,4309390,4137790,4302620,4217110,4196240,4309910,4384580,4419030,4420300,4116370,4381660,4420700,4231530,4329210,4366750,3503740,4367300,4304490,4335650,4042710,4215630,4223890,4090870,4271090,4397470,4329910,4323360,4422520,4334730,4053950,4220320,4405440,4407820,4246320,4049930,4280110,4305000,4038450,4314360,4400200,4287070,3851250,4345170,4400060,4151380,4389790,3701170,4393530,4250450,4338010,4100220,4131570,4300600,4326080,4244250,4410660,4127380,4342530,4135670,4315090,4332510,4293720,4343960,4398640,3692800,4276820,4276290,4388700,4088390,3936690,4091760,4420340,3930700,4390540,4263210,4301700,4407260,3904060,3905820,4419680,4094290,4228490,4030470,4189620,3675660,4383390,4270210,4345540,4424640,4247370,4060280,4416250,3411750,4380110,3147020,4339520,4163180,4103950,4122880,3989260,4389620,4239500,4103070,4010610,4249710,3781970,4416240,4291860,3758220,4245180,4292850,4332220,3815740,4431220,4123610,4420140,4403080,4332070,2942570,1659130,4104290,4172280,4246620,4233900,4291630,4078990,4210320,4358100,4395070,4029460,2892260,4437620,4219120,4098740,4405490,4387300,4308690,4037540,3929910,4395280,4321410,4324500,4160300,4162420,4397570,2824900,4237800,4389110,4419730,4029820,4206190,4378900,4343740,3900710,3978650,4053460,4381550,4309410,4210770,4172130,3969620,4232940,3706630,3204630,3495080,4335780,4300070,4137020,4028910,4420110,4281900,4162380,4065950,4277750,4269730,4042630,4344990,4309470,4421920,4214870,4253700,4229440,4025350,4290310,4150050,4356110,4412390,2768330,4359370,4371160,4301160,4099390,4340870,4439410,4285980,4386430,4069700,4289010,4197110,4367860,4282630,4296210,4336480,4239730,3836620,4270690,4393100,4287270,4336210,4101230,3624030,4224400,4387320,4369340,4199020,4346330,4183570,3833720,4358400,3667470,4412270,3144330,4161650,4402160,4286380,4274930,4268910,4393010,4402620,4237190,4345770,4164710,4231870,3083680,3107190,4308750,4338390,3402510,3871290,3956680,4161460,4256940,4328040,4412750,4401030,4294700,4282530,4346520,4355230,4029720,4247190,3838800,4367250,3212390,3444070,4240160,3944770,4236970,4221640,4381690,4287190,4366620,4392050,4093050,4309060,4405270,4420030,3939640,4230620,4271580,2203010,2408360,4309170,4191890,4396330,4333450,4099590,4211220,4365160,4310160,4148150,4285460,3970630,4294600,3340480,4355720,4371260,4360350,3945740,4330370,4264430,4403330,4272120,4162880,4120840,4256620,4390800,4094910,4351370,3908690,1315060,3366880,3676940,4177290,4165650,4293980,3887730,2440530,4022340,4209380,3988710,3001300,4405390,4207480,1918060,3936570,4054170,4182320,4305400,4222530,4187560,4325110,4357510,4388610,4404260,4201900,4207380,4344100,4412100,4211680,4274340,4396400,3818110,4387450,4300300,4279280,3979510,4315170,4234410,4306800,4297510,4296600,4305710,4308140,4060340,4139480,4409900,4422620,4070770,3804770,4285890,4411950,4331830,4373660,4295660,4013710,4403180,4057840,3831490,4160530,4213070,4412250,4060440,4304390,3870460,4366300,4298950,4384020,4200700,4273960,4261990,4198570,4093710,4079190,4205610,3411340,4286150,4167740,3940690,3913670,4290710,3840060,4406920,3939620,4170990,3367110,3546280,3993190,4288860,4179780,4316270,4258320,4394400,4191410,4335000,4109290,4278000,4246280,4208510,4068380,4381270,4417320,4072040,4304920,4312660,3989740,4320000,4302870,4247620,3569930,4206970,3548560,4400140,3989770,3994240,4204070,4160790,4368760,4345820,4178000,4224940,4272160,3952270,4225690,4337490,4376140,4446740,4257060,4331090,4377900,3434100,4396200,4234820,3537900,2987220,4360610,4335940,4291790,4308880,4372930,4418310,4396720,4335950,4227520,4402220,4409710,4405870,4075200,4418840,4371230,4386450,4393430,4376050,3807410,4305970,4084250,4349780,4321140,4360960,4129140,4218140,4255750,4371750,4401880,4432420,4357290,4387080,4204030,4262370,4380340,4395780,4402000,4277870,4305120,4022940,4327030,4420130,4300670,4220890,4156740,4417810,4119170,3726560,2824090,4353130,4254060,4308230,4329990,4365250,4217980,4129130,4135970,3811850,4293880,3709970,3921450,4354800,4332720,4288370,2680590,4297570,4419880,1545070,4355630,4141470,4410620,4034860,4373240,4415450,4284740,3947000,3962730,4152070,3485450,4236250,3807330,4253520,4328000,4351040,4288590,4077660,4368210,4380720,3938520,4095110,4018490,4360750,4204250,4393730,4415610,4306180,4106700,3960100,4263050,4205620,3789520,2993480,4129650,4227260,3819240,4273590,4315030,4205000,4400220,4168910,4225600,4311640,4413780,4202310,4135610,3733260,3992900,3426620,4285380,4437590,4122670,3064460,4236140,4252460,4295260,4272890,4367520,4394000,4266260,4289810,4393170,4106770,4213860,4349960,4048840,4147920,4006490,4082230,3939900,4106690,4361590,4436460,3973910,4309420,2910420,4145480,4311110,4351150,4417300,4185000,4022510,3782300,4098100,3406030,4423460,4195130,4270700,4300290,4211550,4309380,4415940,4369590,3833060,4162860,4390750,4418520,3760420,4211400,4177800,4387180,4253360,4352300,3720780,4323400,4320240,4240350,4195800,4100440,4403740,4035380,4387350,4378660,3256660,4356370,4354440,4408580,4115110,2575180,3963700,3801710,3709330,4009590,3887950,4328010,4343230,4412860,4216510,4268350,4335840,3781730,4276830,4101180,4245270,4356850,4344570,4354620,4400000,4249840,4250980,4357740,4022140,4258980,4269620,4212950,4132990,4394660,4191030,4421020,2650000,4342660,4195070,3901790,4345200,3923450,4124030,4308190,3972310,4247340,4021990,2524210,4308160,4067230,4260970,4214880,4383400,4295370,4049150,4388410,4362190,4264660,4288440,3853420,4314450,4353030,4185570,3122160,3718700,4415330,4308680,4156200,4167400,4051860,3996770,2404150,3782160,4197140,3735440,4237430,4308280,4412770,4200380,4398180,4119340,4157210,4349440,4204910,4351600,4101350,4250880,4187260,3559900,4414720,4369160,4158510,4081320,4427370,4397600,4292450,4207250,4006050,3499930,4388550,4174450,4346500,3842790,4239820,4171580,3865710,2542360,4229430,4317410,4218150,4105280,4145800,4366850,4367670,2162560,4286360,4106740,4290350,4424280,3916930,3878430,4000420,4423080,4131600,4243270,4363070,4239220,4412030,4245420,4416990,4352260,4195520,4075940,2423690,4034010,4146750,3673770,4295950,4385160,3820790,4309290,4196600,4368230,4365970,3843030,3102690,4213980,4157490,3963570,4034200,4174920,4419630,4253480,3901580,3627470,4366040,3737220,4362330,4403020,4260110,4202440,4406820,4323580,4400570,4434280,4356200,4137930,4225420,4319850,2173720,4315490,4362530,4303710,1638150,4295080,4310590,3947670,4419060,4300310,4329270,3705360,4327340,4407180,4048070,3101540,4083650,3908650,4322110,4230000,4167330,4132490,4377550,3627610,4199390,4344130,4286670,4391780,2947990,4419850,4379120,4416680,4272210,4276930,4384370,4092120,4291470,4296190,4313770,4379830,4295980,3713630,4059630,4109080,4054560,4278780,4222240,4356260,4240720,4344820,4317920,4236990,4328220,3259100,4296300,4145640,3026550,4241210,3963180,3639690,4418880,2561540,4101340,4045250,4367010,4356390,4188030,4137490,4310230,4166240,4309780,3972240,3890480,4172220,4047540,4152540,4244450,4397970,4196270,4323440,4354730,4287610,4325550,4406700,3479060,3972820,3804700,4388520,4296230,4095060,4054670,3626640,3394150,4326250,4174670,3303620,4175490,4418490,4095390,3737560,4384570,4347090,4418710,4335240,4422600,4265720,4192510,4285710,3824150,4382600,4303390,4207950,4400820,4361880,4397980,4327430,3512550,4296940,3918690,4036390,4080930,4414170,4134840,4098640,3630220,4354540,3903040,4328420,4362700,4330310,4237410,4402210,2631040,4344710,3796560,4269190,4308020,4254640,3955670,4402230,4064340,4378300,3034610,4312570,4329350,3586780,4240310,2750510,4099730,4412990,4097530,4369790,3950650,4410330,4099470,4345890,4329900,4239330,4328910,4381570,4262760,4343150,4037880,4291770,4356880,4359140,4301080,4078170,3356510,4434340,4093080,4086880,4235680,4254530,4081600,3973540,4074410,4261860,3017970,4355150,4350450,4241370,4410760,4355360,4293450,4222190,4273030,3910770,2128090,4334990,4122850,4350610,3948340,3235860,4324360,3999400,4244760,2811660,4304250,4014410,4373080,4366000,4351050,2594770,4104940,4171260,3955190,4408240,2824290,4200710,3768940,3713340,3881090,3794310,4225430,4091410,4344670,4345560,4303630,4300250,4383820,4422860,4000500,3959490,4368430,3150270,4043990,4355050,4343760,4117600,4250200,4248000,4238050,3209150,4045240,3647640,4378820,4323530,3964660,4248690,4286280,4193560,4346570,3048320,4357860,4366600,4222120,4423150,4380950,4380470,4198370,4227180,4370350,3808070,4244750,4319110,3957010,4210970,4042380,4172620,4209340,4297010,4244230,4370660,4348210,3967120,4423130,4199850,4415930,3998170,4399630,4268310,4338440,4138660,4075460,4315940,4295640,4198140,3960320,4265940,3317770,4193880,4100010,4423160,3465980,4306350,4294360,4203430,4149810,4357520,3836600,4293070,4375050,4329860,4419090,3930180,4426870,4314890,4324340,4027870,4087490,4416050,4291670,4221580,4188990,4070960,4308510,4254700,4375460,3730740,4291660,4203650,4297060,4336780,4209000,4366740,4276430,4144130,4324950,4169030,3981700,4379810,4274850,4249330,4271870,4366430,4055430,4109130,4405290,2872680,4362630,4390840,2286310,4408370,4336670,4351340,4084290,4131880,2846760,4056940,4248400,4122190,4043500,4373110,4329930,4148040,4037810,4353550,4224190,4414060,3451510,4408200,4056290,4256790,4324680,4352480,4247330,3498920,4135350,3481400,4419820,4061460,4405980,4004880,4234060,4170580,4240590,4407270,4294230,4407090,4269680,3318480,4245540,4386500,4091100,4341160,4340690,4353420,4244410,4055230,4267310,4308780,2955260,4352700,4055090,4365800,4342090,4281810,4321340,3958090,4388250,4357540,3985630,4231580,4143080,4238900,4106710,3630670,4349990,3971850,4260170,3782250,4060900,4273770,4359380,4220850,4350440,3889630,4282700,4370280,4307030,4237840,4391700,4234920,4365150,4109530,4366560,4262470,4270260,4318980,4393870,3956950,4095430,4244670,4232710,4347000,4087730,4448310,4349450,4195390,4285400,3911470,3305340,4412180,4353670,4409380,3227330,4356820,3737690,4090400,4287360,3630500,4378330,3910470,4361140,4387260,4411490,4380800,3931300,4288400,4121320,4387520,3196200,4119300,4320590,4365240,4419050,3744960,3837950,3672480,4388750,4237880,4218340,4262050,4409470,3465000,4120650,3767130,4219580,4387890,4274060,4412470,4405810,4237930,4426640,4287940,3558340,3622680,4326240,4399830,4366100,4318570,4183220,4292090,4259590,3986370,4371360,4266570,4277030,4384240,3821770,4237650,4015610,4349690,3962090,4414680,4174590,3996600,1190520,4380990,3997070,4106480,4119920,4316640,3910760,4388090,4049480,4296800,4363210,4044560,3988680,4281610,4185120,3690120,4380930,4291960,4087860,3913040,4434740,4299360,4235970,4370600,4299660,4301500,4256220,4309210,4434020,4312490,4155370,3295950,3874250,1376780,4186470,4101450,4060390,4045830,3112430,4308640,4146370,2682750,4390130,4362000,4054570,3972050,4286560,4226030,3768680,3723540,4347640,4050060,4201660,4356920,4049280,4189140,4096260,4091270,4405230,4236730,2346300,3668060,4344200,4068110,3962990,4061810,4228710,3491360,4327600,4019290,4303700,4363280,4263150,3752830,4117980,4068000,3434860,4292820,4155410,4265910,4329540,4349810,4289620,3302890,4423560,4283560,4101460,4356080,4186520,4086130,4306970,4393630,4199450,4396650,4333670,3875500,4210690,4367190,2917950,4295510,4180190,3591070,3999620,4144400,4203950,4235870,3755240,4245940,4278430,4368330,4004700,4117370,3845740,3124660,2968480,4393620,4317280,4395150,4360910,4393410,4222660,3978600,3174030,4122560,4338050,3724230,4421170,4196300,3986950,4322700,4011730,4275070,4351360,4084090,4414920,4269410,4156760,4349490,4282990,4409980,4355240,4171720,4257660,4197180,4175340,4406490,4410030,4259270,4006000,4300810,4067660,4275390,4014060,3729420,4287640,4333210,3493170,4188930,3500440,4169400,3329390,4307660,4422730,4323080,4346620,4075550,4405830,4410200,4287180,4366050,4338970,4324810,3540930,2809080,3450580,4345790,4176290,4128430,4289220,4412230,4230910,4339760,4296710,4367920,4258740,4283790,4024480,4106030,4402860,4325830,4262560,3933570,3844610,4278300,4426070,1530420,4436750,4414240,4342810,4329470,3877530,4110800,3886320,4440850,4274760,4367220,3968550,4117270,4420930,4322930,4237750,4390610,4366460,4104500,4423630,4412400,4381510,4307510,4383650,3734810,4035120,4279000,2731210,4025200,3349210,3341160,4317810,4395940,3689050,3993800,4333350,4378990,4355980,4415300,3793880,4152020,4178420,4246170,3873050,4168980,3984720,3862720,4327220,4333370,4286600,4049130,4160810,4369900,4281600,4352800,4308840,4296420,3902480,4397080,3862480,4148050,4258350,4364450,2630940,4244520,4222810,3853050,4004740,4300100,4276070,4376550,3941100,4403750,4252240,3548730,4229990,4292210,2859850,4341870,4351660,4283280,4224580,4305220,4141810,4411150,3845030,4202150,4376640,4207310,4373210,3933140,4236950,3364300,4287230,4251300,4425950,4268810,3853360,4269370,3121660,3297100,4037600,2577030,4406780,3157740,4406580,3679450,4290960,4318900,4398410,4369950,4218100,4304810,4348330,3957750,4412330,4244200,4254610,4410210,3587250,3868240,4029880,4316810,4359030,4283600,4367440,4362580,4030090,4025550,2630440,4346060,3767000,4305940,2934410,2476700,4423500,4261350,3816250,4019260,4143510,4334060,4439220,3588520,4084780,4047060,4388640,4107600,4196040,4193820,4315920,4371340,4337180,4358620,4389420,4277350,4331860,4269850,4358300,2454700,4176180,3575200,4198580,4074300,4355000,4143930,4421720,4156120,3987310,4389700,4328330,4405210,4192710,4277830,3760120,4258850,4288070,4201320,4343630,4115310,4381970,4121770,4408080,4156650,4371130,3967930,4231290,4262330,4236520,4370120,4300710,4387460,4392100,3537770,4273460,4348220,4279840,4241120,4316600,4182730,4155770,4295480,4367390,4397650,3788960,4273470,3963110,4274900,4320630,4381420,3474370,4122440,4060420,4271300,4287920,4313420,4343570,4329170,4032340,4142070,4149670,4237890,4302140,4424810,4302010,3956040,4289390,4210280,4352550,4345680,4407700,4361690,4150240,4417560,4107710,3684510,4396310,4366710,4354410,4193220,3584810,4445310,4152370,2480110,3423530,4081680,4086220,4321910,4339450,3724850,2950480,4371330,3797540,2526710,3668130,4409000,3953670,4368470,4025170,4334880,4089360,3634250,4114300,4227330,4418750,4300380,4390820,4392010,4411620,4307640,4395700,4109100,4298410,4334800,4277490,3734420,4102300,4401290,4322060,4353270,4186930,4343550,4305930,4347920,4216980,4379580,4149060,3286940,4367650,1733200,4367770,4258270,4415150,4365650,4236120,4365760,4317840,4241900,4221520,4323850,4196220,4005910,4071420,4147940,4355940,4349500,4409490,4367470,4445320,4216050,4358490,3984990,4414600,3564640,1028670,3407110,3988240,4282570,3806490,4266490,4123850,4370850,4003800,3884320,4321220,4407060,4409600,4353950,4225480,4022180,4315520,3426800,4235520,4420560,4269460,3444700,4329890,3405650,4406620,4418480,4311720,4397800,4203660,4319280,4158320,4267790,4101880,4353720,4321040,4415310,4120670,4258310,4083320,3846140,3819690,3985780,3794830,2938240,4253960,3405900,4285100,4419020,4221190,4431150,4370240,4412660,4200950,4252560,3961810,3132850,4364020,4371560,3582300,4291900,4032190,4080890,4222400,4197190,4148220,4304940,4246940,4042050,4242190,4038010,4212350,4348900,4409810,4171900,4417850,4151630,4299420,4158730,4078020,4139840,2769400,4021400,4374360,4351110,4292430,4226730,4211190,4211530,4348480,4219780,4439430,4380630,4157710,4372200,4386640,4380660,4108640,3942880,4308650,4381720,3938060,4303190,3353560,4104270,4413770,4077910,4066740,4212620,4231000,4054630,4037790,4406130,4238000,4149780,4092100,4354480,4403170,4297090,3576200,4235590,4196020,4408800,4225830,2275930,4371080,4154710,4265610,4360370,4078300,4227760,3410010,4310990,4099550,4349770,4224850,4257180,4004320,4381730,3996750,3611990,4309790,3911940,4269710,4284860,4374680,4412130,4225340,4382110,4275760,4263340,3111100,4401920,4283860,3987010,4251440,4345700,3692850,4359820,4124780,4339170,3973170,4410320,4219950,4403810,4238340,4201730,4265700,4138260,4249950,4346440,4396220,4149800,4276570,4100820,4205560,3759370,4138840,4407610,4146320,4316310,4318600,4309600,4366270,4322200,1225500,4253000,3976840,4104580,4397620,4341640,4414200,4122790,4231310,3940840,4412170,4064840,3860990,4275790,3241430,4222940,4314220,4149680,4041400,4398380,4365260,4028420,3650480,4374550,4078700,4361780,3704390,4067360,3914450,3786770,3880530,4259080,4031040,4305320,3820720,4406940,4400740,4347730,4139500,4389130,4177530,4376200,4417880,3700780,3148980,4281780,4252050,4084190,4337250,4333170,4353970,4342000,4335250,4395120,4020940,4368940,4392580,4289980,4287120,4374350,4201470,4233480,3869120,4367500,4407550,4254710,4402560,4252670,4220930,4196310,4253540,4411360,4384420,4116740,4054890,3668660,4368460,4177040,3871280,4063240,4308480,4116430,4184780,4275230,4048780,4386370,3950660,4099130,4079460,4153790,4347870,4076710,4420320,4255060,4276130,4319060,4264890,4231180,4382040,4144500,4279940,4420780,4159500,4271060,4252220,4422780,4148610,4200300,4357530,4022160,3034020,4428840,3876520,4169910,4285650,4370310,4324930,4231710,4047000,4188820,4066890,4256380,4340160,3654770,4209320,4324050,2983200,4032010,4422270,4391800,4319990,4415690,3450640,4399910,3859960,3730700,4319550,4405100,4237150,4229800,4379290,4237010,4069970,4377840,4383490,4068900,4147330,4408590,4160480,4304970,3493090,4304040,4350860,3988760,3712450,4324350,4127860,4390290,4310820,4283760,4300390,4282520,4253670,4241750,4118130,4409540,3224140,4272950,3796410,3352170,4269940,4353150,4398460,3806130,4321740,3838410,4270650,4419340,4324460,3870380,3907600,4381830,4298860,4264450,4383740,4367240,3522050,3965390,4292680,4302520,4221030,3950390,4278280,4119380,4093610,4294050,4361560,4330920,4312670,4149650,4328340,4094960,4287560,4317200,4211970,3049430,3996890,4380210,3955070,4236040,4396390,4085990,4178890,4118570,4300590,4358160,4307690,4377540,3701920,4418820,4371660,4089570,4018770,4274710,4401550,4351580,2321050,3678390,4217000,4402460,4299780,4241620,3563310,3643460,4391240,4303100,4382700,3999420,3423710,4169450,4364050,4323980,4396860,3751670,3157200,4338840,4095810,4197910,3852140,4332340,4372270,4183790,3597240,4191920,4416520,4246440,4361890,4339550,3774770,3923530,4370730,4015520,4086050,4296880,4389080,3910420,3180160,4359690,4338520,4137420,3949600,4296760,4264160,4026730,4015550,4033300,4233890,4020170,4293150,4177980,4356160,4172800,4323760,4263910,4425920,4424350,3437660,4085590,4211200,4116500,4224630,3841030,4004780,4048610,3832340,4225500,4096300,4008940,4395820,4328430,4248580,4392940,4357260,4419840,3920700,4422570,4290300,4380060,3231430,4352770,4410770,4158750,4339860,3685150,4140980,4409240,4231260,3991630,4313740,4346840,4371700,4327090,4383450,3943040,4040490,4396410,4280970,4144340,4409110,3994590,4380270,4234000,4289200,4164320,4432830,3224230,4417640,4026380,4367510,3104480,3487470,4397490,4264360,3634980,4378270,4360730,4414710,4372380,4146490,4404600,4266230,4241990,4273920,4390090,4405690,4141890,4274050,4092930,4410970,4381450,4312560,4038360,3375600,2946400,4246510,4294690,4120510,4369610,4129840,4088240,3775220,4272580,4199530,4382180,4018930,4063310,4083880,4141650,4425430,3812500,4013470,4111770,4417940,4036010,3972800,4095730,3929680,4099940,4422580,4253550,4089630,4190340,4085540,4293530,4244360,3457750,4355440,4275210,4188700,4315700,4332140,4152290,4321630,3989370,4348890,4286390,3959300,4320050,4297120,4284700,4393880,4231910,4268760,3685500,4410470,4146560,4037330,4104190,4175410,4409330,4305860,4074210,4379260,4185380,3175090,4415780,3898440,4370760,3761970,4324100,4367800,4257770,4055550,4273850,3821130,4047930,4134200,4327750,4310940,4403730,4221350,4360360,3387170,4412440,4411920,4344980,3103990,4230020,4291930,4396380,4383100,4359550,4234670,4142750,4333260,4388760,4402110,4415070,4415110,4121590,4217900,4369030,4275380,4269350,4194940,4358740,4362340,4227890,4396880,3801100,4012420,4257090,4366870,3966550,4222200,4406430,3739310,4103240,3641710,3928590,3954840,4158470,4313170,4054600,4220760,4199730,3682340,3701340,4292620,4191100,4068820,4350950,4023610,4408840,4211230,3795740,4196430,4096210,4257620,3679490,4418850,4204330,3730380,4414000,3863430,4356600,3885370,4041880,4419400,4324190,4341580,2940720,4225220,4396010,4322210,4002470,4341340,4413090,4368030,4081210,4309450,4241220,4428940,4151760,4350390,4098780,4343520,4193340,4390120,4294710,4156670,4257950,4187770,4199080,4088020,4402770,4314250,3660890,3864340,4229950,4159360,4341110,4234900,4153660,4426380,3350900,3774630,4236500,4090800,4361030,4427070,4057640,4254580,4307230,4062040,4373590,3108370,4020100,3677100,3763410,2849630,3424160,4400290,4224860,4309510,3988840,4168340,4417420,3119940,3640210,4201980,4336150,2535030,4403830,4002940,3634480,4266050,4360210,4077950,4024820,4225100,4075040,3700700,4210940,3797030,3953260,3922270,4398600,4342550,4321070,4436210,4309360,4162480,4101810,4265250,4266590,4423190,3931710,4073820,4243420,3898780,3854700,4430850,4182590,3797050,4378790,4370710,4418580,4221440,3638700,3683720,3992510,4078660,4299400,4211740,4097940,3654910,4410430,4251150,4337030,4314150,3951090,4070340,4188950,4276270,4230010,4243310,4220950,4220800,4300570,4292010,4390500,3511260,4301900,4305240,4107000,4272300,4394390,4181090,4323700,3218650,4349290,4384390,4283150,4277050,4275330,4412240,4206110,4275200,4119060,4450950,4233410,4102340,4317660,4216490,3629420,4070010,4187220,4407810,4410010,4333890,4252810,3679560,4368120,4090600,4277570,4291580,4409880,4229660,4305640,3860660,4060670,3932590,4292550,4278960,4299530,4326700,4174680,4036280,4346300,4309160,4298310,3453270,4205540,3765410,4287170,4308450,4290450,4135850,4062070,4171280,4435690,1182350,4287990,4354920,4343410,4314110,4368620,4054160,4374590,4256510,4005850,4113490,4160260,4406910,4325580,4001150,4448940,4041420,4374850,4256840,4029310,3547050,4404890,4229010,4116940,4190970,4356470,4407380,4295280,3488260,4419570,4040970,4264940,4199950,4268340,4277670,4328810,4345000,4176700,4207750,4079910,4136700,4435430,4312720,4404660,4266740,3322870,4347470,4421390,4137130,4411550,4026650,4398000,4294510,4299650,4389740,4164180,4406160,4346510,4328020,4134040,3941190,3765600,4389230,4244850,4200600,4409770,4233860,4257380,4283290,4214070,4084950,3564480,4084720,4351390,4211390,4366930,3698500,4231770,4368450,4355100,3468080,3267580,2540770,4405660,4418970,4350670,3846810,4379900,4413000,4419500,4207370,4238980,4438020,4405610,4275690,3976260,4386310,4345250,4128040,4255280,4420040,4371290,4135660,4374740,4204260,4344070,4379030,3664420,4306360,4244920,4365010,4348150,4245050,4318450,4097070,3805550,4169180,4069680,4073720,4387710,3859010,4315540,4085170,3977370,4370800,4071600,4268770,4129520,4364720,4382720,4155630,4088160,3973030,4151480,3252470,1676460,4332030,4217560,4416110,4275990,4183050,3555290,4079180,3346210,3953090,3893960,4297770,4276640,4217620,4179920,4252130,4410340,4251130,4072450,3899790,4000880,3961140,4371990,4445040,4404330,4405310,4008410,4419270,4374650,4298480,4224420,4046190,4341440,4200100,4227370,3222870,4154070,4157700,4250390,4213800,4080380,3757320,4228320,4304680,4414830,4128230,4430820,4418650,4407870,3454010,4312340,4263540,4281730,4411260,4119470,4224890,4195880,4237950,3022090,3989510,3980760,4277160,4290260,4286830,4339050,4304630,3955580,4082790,4283520,3919250,4255330,4330530,4357330,4045090,4232140,4419780,4017310,4200230,4334010,4181270,4430620,4320890,4023730,4157100,4341800,2832190,4240120,4299310,3652950,3944220,4410420,4033370,4401470,4415830,4431600,4306150,3667600,4251060,3253810,4198350,3500550,4052300,3822880,4175450,3596360,4336690,4139370,3948710,4350550,3585290,4302260,4325380,4384540,4272450,3629520,4060120,4236760,4420310,4386940,3825440,4246430,4188550,4152530,4315310,4414510,4209250,4357640,4321100,4321830,4442500,3955630,4258940,4340220,4309430,3606110,3464060,4405040,4334000,4408400,4286940,4367690,4141280,4287620,4256100,3547600,4280670,4308830,4313720,4004840,4329920,4107750,4122900,3820930,4348350,4319050,4258300,4409660,4308730,4102880,4339360,4415840,1837770,3405030,3548940,3092480,3388630,3716490,4361570,4159560,4426420,4371550,4374600,3470630,4017660,4349920,4045400,3973130,4304660,3909650,4176480,4374630,4390530,4273910,2819490,3814820,4333110,4203920,4030670,4057620,4344810,3559030,3313550,4214750,4025430,2556770,4046620,4078940,4445500,4281700,4430160,4288890,4397900,3737160,3973490,4364350,4396700,4264820,4340860,3086530,4444590,4381680,4162250,4121250,2379320,4365670,4422710,4177200,4273300,4032750,4077640,4429300,4167780,4382410,4063070,4276120,4186990,4221830,4252400,4288210,4213590,3565830,4350420,4413980,4236920,4414150,4238840,4225460,2906630,4400380,4393380,4142770,3460180,3991240,
    ]

    if len(sys.argv) > 1:
        appids = [int(a) for a in sys.argv[1:]]

    asyncio.run(main(appids))